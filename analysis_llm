import os
import json
import glob
import pandas as pd

# ================= é…ç½®åŒºåŸŸ =================
# è¯„ä¼°æŠ¥å‘Šæ‰€åœ¨çš„ç›®å½•ï¼ˆå³ä¸Šä¸€ä¸ªè„šæœ¬çš„ OUTPUT_DIRï¼‰
REPORTS_DIR = "/raid/data/ly/data/dataset/data_eval/reports"

# æ’é™¤çš„é—®é¢˜å…³é”®å­—ï¼ˆQuestion 3, 7, 8ï¼‰
# è„šæœ¬ä¼šæ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶åæˆ–å†…å®¹ï¼ŒåŒ…å«è¿™äº›ç¼–å·çš„å°†è¢«è·³è¿‡
EXCLUDE_QUESTIONS = ["question3", "question7", "question8"]

# å®šä¹‰æˆ‘ä»¬è¦åˆ†æçš„ä¸‰ä¸ªç»´åº¦
DIMENSIONS = ["logical_coherence", "tool_usage_validity", "goal_efficiency"]
# ===========================================

def analyze_reports():
    # è·å–ç›®å½•ä¸‹æ‰€æœ‰çš„ json è¯„ä¼°æŠ¥å‘Š
    report_files = glob.glob(os.path.join(REPORTS_DIR, "*.json"))
    
    all_folder_stats = []

    print(f"ğŸ” æ­£åœ¨è¯»å–æŠ¥å‘Šç›®å½•: {REPORTS_DIR}")
    
    for file_path in report_files:
        filename = os.path.basename(file_path).lower()
        
        # 1. è¿‡æ»¤æ‰ Question 3, 7, 8
        if any(q in filename for q in EXCLUDE_QUESTIONS):
            print(f"â­ï¸  è·³è¿‡æ’é™¤çš„é—®é¢˜: {filename}")
            continue
            
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                report_data = json.load(f)
            
            details = report_data.get("details", {})
            folder_name = report_data.get("meta_summary", {}).get("dataset_path", "Unknown")
            folder_label = os.path.basename(folder_name.rstrip('/\\'))

            # 2. æå– run_001 åˆ° run_030 çš„åˆ†æ•°
            scores_list = []
            for run_id, run_data in details.items():
                # è¿‡æ»¤æ‰ batch_summary å’Œ question_info (é€šå¸¸è¿™äº›ä¸ä¼šåœ¨ details é‡Œï¼Œä½†åšä¸ªä¿é™©)
                if "run_" not in run_id:
                    continue
                
                # æå–ä¸‰ä¸ªç»´åº¦çš„åˆ†æ•°
                indiv_scores = run_data.get("individual_scores", {})
                row = {
                    "folder": folder_label,
                    "run_id": run_id,
                    "logical_coherence": indiv_scores.get("logical_coherence", 0),
                    "tool_usage_validity": indiv_scores.get("tool_usage_validity", 0),
                    "goal_efficiency": indiv_scores.get("goal_efficiency", 0)
                }
                scores_list.append(row)

            if not scores_list:
                continue

            # 3. è½¬æ¢ä¸º DataFrame è¿›è¡Œç»Ÿè®¡
            df_folder = pd.DataFrame(scores_list)
            
            # è®¡ç®—å½“å‰æ–‡ä»¶å¤¹çš„ç»Ÿè®¡æŒ‡æ ‡
            stats = df_folder[DIMENSIONS].agg(['mean', 'std', 'min', 'max']).T
            stats['folder'] = folder_label
            all_folder_stats.append(stats)

            # æ‰“å°å½“å‰æ–‡ä»¶å¤¹çš„ç®€è¦åˆ†æ
            print(f"\nğŸ“Š æ–‡ä»¶å¤¹åˆ†æç»“æœ: {folder_label} (æ ·æœ¬æ•°: {len(df_folder)})")
            print(stats[['mean', 'std', 'min', 'max']].round(2))

        except Exception as e:
            print(f"âŒ å¤„ç†æ–‡ä»¶ {filename} æ—¶å‡ºé”™: {e}")

    # 4. æ±‡æ€»æ‰€æœ‰æ–‡ä»¶å¤¹å¯¹æ¯”
    if all_folder_stats:
        print("\n" + "="*60)
        print("ğŸ“ˆ æ‰€æœ‰æœ‰æ•ˆæ–‡ä»¶å¤¹ (é™¤ Q3,7,8 å¤–) çš„å‡å€¼å¯¹æ¯”")
        print("="*60)
        
        # æ•´ç†æ±‡æ€»è¡¨
        summary_rows = []
        for s in all_folder_stats:
            folder_name = s['folder'].iloc[0]
            row = {"Folder": folder_name}
            for dim in DIMENSIONS:
                row[dim] = round(s.loc[dim, 'mean'], 2)
            summary_rows.append(row)
        
        summary_df = pd.DataFrame(summary_rows)
        print(summary_df.to_string(index=False))
        
        # ä¿å­˜åˆ°æœ¬åœ° CSV
        output_csv = os.path.join(REPORTS_DIR, "final_statistical_analysis.csv")
        summary_df.to_csv(output_csv, index=False)
        print(f"\nâœ… æ±‡æ€»æŠ¥å‘Šå·²ä¿å­˜è‡³: {output_csv}")
    else:
        print("âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¯„ä¼°æ•°æ®è¿›è¡Œåˆ†æã€‚")

if __name__ == "__main__":
    analyze_reports()
